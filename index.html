<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spell & Draw - Learning App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 3rem;
            color: #6a1b9a;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .score {
            font-size: 1.2rem;
            color: #7b1fa2;
            font-weight: bold;
        }

        .word-section {
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            padding: 30px;
            margin-bottom: 30px;
        }

        .word-challenge {
            text-align: center;
            margin-bottom: 25px;
        }

        .word-challenge h2 {
            font-size: 2rem;
            color: #333;
            margin-bottom: 15px;
        }

        .spelling-content {
            display: flex;
            flex-direction: column;
            gap: 30px;
            align-items: center;
        }

        .word-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .word-image {
            width: 150px;
            height: 150px;
            object-fit: contain;
            border-radius: 15px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            margin: 0 auto 20px auto;
            display: block;
            background: white;
            padding: 10px;
        }

        .hint {
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 20px;
        }

        .spelling-area {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 25px;
            min-height: 70px;
            align-items: center;
            flex-wrap: wrap;
        }

        .letter-slot {
            width: 60px;
            height: 60px;
            background: #2196f3;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .letter-slot:hover {
            background: #1976d2;
            transform: scale(1.05);
        }

        .empty-slot {
            background: transparent;
            border: 3px dashed #ccc;
            color: #999;
            cursor: default;
        }

        .empty-slot:hover {
            transform: none;
        }

        .available-letters {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            padding: 20px;
            border: 2px dashed #e0e0e0;
            border-radius: 15px;
            background: #fafafa;
        }

        .available-letter {
            width: 70px;
            height: 70px;
            border: none;
            border-radius: 15px;
            font-size: 1.8rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .available-letter:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        .check-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .check-btn:hover:not(:disabled) {
            background: #45a049;
            transform: translateY(-2px);
        }

        .check-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .drawing-section {
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 30px;
            display: none; /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 100;
            overflow: auto;
        }

        .drawing-section.show {
            display: block;
        }

        .drawing-section h3 {
            text-align: center;
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 20px;
        }

        .drawing-reference {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .reference-image {
            width: 120px;
            height: 120px;
            object-fit: contain;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            background: white;
            padding: 10px;
        }

        .trace-toggle {
            background: #ff9800;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .trace-toggle:hover {
            background: #f57c00;
        }

        .trace-toggle.active {
            background: #4caf50;
        }

        .canvas-container {
            border: 3px solid #ddd;
            border-radius: 12px;
            overflow: hidden;
            background: white;
            display: flex;
            justify-content: center;
            margin: 20px auto;
            max-width: 90vw;
            max-height: 60vh;
            position: relative;
        }

        #traceCanvas {
            position: absolute;
            top: 0;
            left: 0;
            cursor: crosshair;
            touch-action: none;
            opacity: 0.3;
            pointer-events: none;
            width: 100%;
            height: auto;
            max-width: 90vw;
            max-height: 60vh;
        }

        .drawing-tools {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .color-palette {
            display: flex;
            gap: 8px;
        }

        .color-btn {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: 3px solid #ccc;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .color-btn.active {
            border-color: #333;
            transform: scale(1.2);
        }

        .clear-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .clear-btn:hover {
            background: #d32f2f;
        }

        .canvas-container {
            border: 3px solid #ddd;
            border-radius: 12px;
            overflow: hidden;
            background: white;
            display: flex;
            justify-content: center;
            margin: 20px auto;
            max-width: 90vw;
            max-height: 60vh;
        }

        #drawingCanvas {
            cursor: crosshair;
            touch-action: none;
            display: block;
            width: 100%;
            height: auto;
            max-width: 90vw;
            max-height: 60vh;
        }

        .next-word-btn {
            display: none; /* Hidden by default */
            margin: 20px auto;
            background: #9c27b0;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .next-word-btn.show {
            display: block;
        }

        .next-word-btn:hover {
            background: #7b1fa2;
            transform: translateY(-2px);
        }

        .success-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .success-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            animation: bounceIn 0.6s ease-out;
        }

        .success-emoji {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .success-title {
            font-size: 2.5rem;
            color: #4caf50;
            margin-bottom: 10px;
        }

        .success-message {
            font-size: 1.3rem;
            color: #666;
        }

        .spelling-section {
            transition: all 0.3s ease;
        }

        .spelling-section.hide {
            display: none;
        }

        .spelling-interaction {
            display: flex;
            flex-direction: column;
            gap: 25px;
            align-items: center;
            flex: 1;
            min-width: 0;
        }

        /* Landscape layout for tablets and larger screens */
        @media (min-width: 768px) and (orientation: landscape) {
            .spelling-content {
                flex-direction: row;
                align-items: flex-start;
                gap: 40px;
            }
            
            .word-display {
                flex: 0 0 300px;
                min-width: 300px;
            }
            
            .word-image {
                width: 200px;
                height: 200px;
            }
            
            .spelling-interaction {
                flex: 1;
                justify-content: center;
            }
        }

        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .word-challenge h2 {
                font-size: 1.5rem;
            }

            .word-image {
                width: 120px;
                height: 120px;
            }
            
            .spelling-area {
                gap: 5px;
            }
            
            .letter-slot {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }
            
            .available-letter {
                width: 60px;
                height: 60px;
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Spell & Draw</h1>
            <div class="score">Score: <span id="scoreValue">0</span></div>
        </div>

        <!-- Success Modal -->
        <div id="successModal" class="success-modal">
            <div class="success-content">
                <div class="success-emoji">ðŸŽ‰</div>
                <div class="success-title">Great Job!</div>
                <div class="success-message">You spelled <span id="successWord"></span> correctly!</div>
            </div>
        </div>

        <!-- Word Challenge Section -->
        <div class="word-section">
            <div class="word-challenge">
                <h2>Spell this:</h2>
            </div>

            <div id="spellingSection" class="spelling-section">
                <div class="spelling-content">
                    <!-- Word Display (Image and Hint) -->
                    <div class="word-display">
                        <img id="wordImage" class="word-image" src="images/cat.png" alt="Word to spell">
                        <div class="hint" id="wordHint">Draw a furry pet that says meow!</div>
                    </div>

                    <!-- Spelling Interaction -->
                    <div class="spelling-interaction">
                        <!-- Player's Spelling -->
                        <div class="spelling-area" id="spellingArea">
                            <!-- Letters will be added here dynamically -->
                        </div>

                        <!-- Available Letters -->
                        <div class="available-letters" id="availableLetters">
                            <!-- Available letters will be added here -->
                        </div>

                        <!-- Check Button -->
                        <div style="text-align: center;">
                            <button class="check-btn" id="checkBtn" onclick="checkSpelling()">Check Spelling</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Drawing Section -->
        <div id="drawingSection" class="drawing-section">
            <div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
                <h3>Now draw your picture!</h3>
                
                <!-- Reference Image and Trace Toggle -->
                <div class="drawing-reference">
                    <img id="drawingReference" class="reference-image" src="images/cat.png" alt="Reference image">
                    <button class="trace-toggle" id="traceToggle" onclick="toggleTrace()">Show Reference Image</button>
                </div>
                
                <!-- Drawing Tools -->
                <div class="drawing-tools">
                    <div class="color-palette" id="colorPalette">
                        <!-- Color buttons will be added here -->
                    </div>
                    <button class="clear-btn" onclick="clearCanvas()">Clear</button>
                </div>

                <!-- Canvas -->
                <div class="canvas-container">
                    <canvas id="traceCanvas" width="1000" height="500"></canvas>
                    <canvas id="drawingCanvas" width="1000" height="500"></canvas>
                </div>

                <!-- Next Word Button -->
                <button class="next-word-btn" id="nextWordBtn" onclick="nextWord()">Next Word</button>
            </div>
        </div>
    </div>

    <script>
        // Game state
        let currentWord = 'CAT';
        let currentWordIndex = 0;
        let playerSpelling = [];
        let availableLetters = [];
        let score = 0;
        let currentColor = '#000000';
        let isDrawing = false;
        let hasDrawn = false;
        let traceVisible = false;
        let referenceImage = null;

        // Letter colors for variety
        const letterColors = [
            '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', 
            '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E9'
        ];

        // Words database
        const words = [
            { word: 'CAT', hint: 'Draw a furry pet that says meow!', image: 'images/cat.png' },
            { word: 'DOG', hint: 'Draw a pet that barks and wags its tail!', image: 'images/dog.png' },
            { word: 'SUN', hint: 'Draw something bright and yellow in the sky!', image: 'images/sun.png' },
            { word: 'CAR', hint: 'Draw something with wheels that drives!', image: 'images/car.png' },
            { word: 'HAT', hint: 'Draw something you wear on your head!', image: 'images/hat.png' },
            { word: 'BAT', hint: 'Draw something that flies at night!', image: 'images/bat.png' },
            { word: 'CUP', hint: 'Draw something you drink from!', image: 'images/cup.png' },
            { word: 'BED', hint: 'Draw something you sleep on!', image: 'images/bed.png' },
            { word: 'BOX', hint: 'Draw something square you put things in!', image: 'images/box.png' }
        ];

        const colors = ['#000000', '#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF', '#FFA500'];

        // Canvas setup
        const canvas = document.getElementById('drawingCanvas');
        const ctx = canvas.getContext('2d');
        const traceCanvas = document.getElementById('traceCanvas');
        const traceCtx = traceCanvas.getContext('2d');
        
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.lineWidth = 8; // Bigger pen size
        
        traceCtx.lineCap = 'round';
        traceCtx.lineJoin = 'round';
        traceCtx.lineWidth = 3;

        // Initialize the game
        function init() {
            setupCanvas();
            setupColorPalette();
            generateScatteredLetters();
            updateUI();
            clearCanvas();
        }

        function setupCanvas() {
            // Mouse events
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            // Touch events
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', stopDrawing);
        }

        function setupColorPalette() {
            const palette = document.getElementById('colorPalette');
            colors.forEach(function(color, index) {
                const btn = document.createElement('button');
                if (index === 0) {
                    btn.className = 'color-btn active';
                } else {
                    btn.className = 'color-btn';
                }
                btn.style.backgroundColor = color;
                btn.onclick = function() {
                    selectColor(color, btn);
                };
                palette.appendChild(btn);
            });
        }

        function selectColor(color, btn) {
            document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentColor = color;
        }

        function getMousePos(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            return {
                x: (e.clientX - rect.left) * scaleX,
                y: (e.clientY - rect.top) * scaleY
            };
        }

        function getTouchPos(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            return {
                x: (e.touches[0].clientX - rect.left) * scaleX,
                y: (e.touches[0].clientY - rect.top) * scaleY
            };
        }

        function startDrawing(e) {
            isDrawing = true;
            hasDrawn = true;
            showNextWordButton();
            const pos = getMousePos(e);
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
        }

        function draw(e) {
            if (!isDrawing) return;
            const pos = getMousePos(e);
            ctx.strokeStyle = currentColor;
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            let eventType;
            if (e.type === 'touchstart') {
                eventType = 'mousedown';
            } else {
                eventType = 'mousemove';
            }
            
            const mouseEvent = new MouseEvent(eventType, {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            
            if (e.type === 'touchstart') {
                startDrawing(mouseEvent);
            } else if (e.type === 'touchmove') {
                draw(mouseEvent);
            }
        }

        function clearCanvas() {
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            hasDrawn = false;
            hideNextWordButton();
            
            // Only redraw reference image if it's supposed to be visible
            if (traceVisible && referenceImage) {
                drawReferenceImage();
            }
        }

        function clearTraceCanvas() {
            traceCtx.clearRect(0, 0, traceCanvas.width, traceCanvas.height);
        }

        function toggleTrace() {
            const button = document.getElementById('traceToggle');
            
            if (traceVisible) {
                // Hide reference image
                button.textContent = 'Show Reference Image';
                button.classList.remove('active');
                traceVisible = false;
                // Clear the entire canvas and redraw it properly
                clearCanvas();
            } else {
                // Show reference image
                button.textContent = 'Hide Reference Image';
                button.classList.add('active');
                traceVisible = true;
                // Clear canvas first to remove any old reference images, then draw new one
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                drawReferenceImage();
            }
        }

        function drawReferenceImage() {
            if (!referenceImage) return;
            
            // Calculate centered position and size
            const canvasAspect = canvas.width / canvas.height;
            const imageAspect = referenceImage.width / referenceImage.height;
            
            let drawWidth, drawHeight, drawX, drawY;
            
            // Scale image to fit canvas while maintaining aspect ratio
            if (imageAspect > canvasAspect) {
                // Image is wider than canvas aspect ratio
                drawWidth = canvas.width * 0.8; // Use 80% of canvas width (increased from 60%)
                drawHeight = drawWidth / imageAspect;
            } else {
                // Image is taller than canvas aspect ratio
                drawHeight = canvas.height * 0.8; // Use 80% of canvas height (increased from 60%)
                drawWidth = drawHeight * imageAspect;
            }
            
            // Center the image
            drawX = (canvas.width - drawWidth) / 2;
            drawY = (canvas.height - drawHeight) / 2;
            
            // Save current context state
            ctx.save();
            
            // Set low opacity for reference image
            ctx.globalAlpha = 0.3;
            
            // Draw the reference image
            ctx.drawImage(referenceImage, drawX, drawY, drawWidth, drawHeight);
            
            // Restore context state
            ctx.restore();
        }

        function loadReferenceImage() {
            const wordObj = words.find(w => w.word === currentWord);
            referenceImage = new Image();
            referenceImage.onload = function() {
                // Image is loaded and ready to use
                // Only draw if trace is currently visible
                if (traceVisible) {
                    // Clear canvas completely first, then draw reference
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    drawReferenceImage();
                }
            };
            referenceImage.src = wordObj.image;
        }

        function drawTraceOutline() {
            // This function is no longer needed - we use the actual image now
        }

        function generateScatteredLetters() {
            // Get letters needed for current word
            const wordLetters = currentWord.split('');
            
            // Add some extra random letters to make it challenging
            const extraLetters = ['B', 'D', 'F', 'G', 'H', 'J', 'K', 'L', 'M', 'N', 'P', 'Q', 'R', 'S', 'V', 'W', 'X', 'Y', 'Z'];
            const numExtra = Math.min(6, Math.max(3, 8 - wordLetters.length));
            
            // Shuffle and pick random extra letters
            const shuffledExtra = extraLetters.sort(() => Math.random() - 0.5);
            const selectedExtra = shuffledExtra.slice(0, numExtra);
            
            // Create a scattered arrangement where word letters are not adjacent
            availableLetters = [];
            const allLetters = [...wordLetters, ...selectedExtra];
            const totalLetters = allLetters.length;
            
            // First, place extra letters
            selectedExtra.forEach(letter => availableLetters.push(letter));
            
            // Then insert word letters at non-adjacent positions
            wordLetters.forEach(letter => {
                let position;
                let attempts = 0;
                do {
                    position = Math.floor(Math.random() * (availableLetters.length + 1));
                    attempts++;
                } while (attempts < 10 && availableLetters.length > 1 && 
                        ((position > 0 && wordLetters.includes(availableLetters[position - 1])) ||
                         (position < availableLetters.length && wordLetters.includes(availableLetters[position]))));
                
                availableLetters.splice(position, 0, letter);
            });
            
            // Final shuffle to ensure good distribution
            availableLetters = availableLetters.sort(() => Math.random() - 0.5);
        }

        function updateUI() {
            // Update current word image and hint
            const wordObj = words.find(w => w.word === currentWord);
            document.getElementById('wordImage').src = wordObj.image;
            document.getElementById('wordImage').alt = `Picture of ${currentWord.toLowerCase()}`;
            document.getElementById('wordHint').textContent = wordObj.hint;

            // Update spelling area
            const spellingArea = document.getElementById('spellingArea');
            spellingArea.innerHTML = '';
            
            playerSpelling.forEach((letter, index) => {
                const btn = document.createElement('button');
                btn.className = 'letter-slot';
                btn.textContent = letter;
                btn.onclick = () => removeLetterFromSpelling(index);
                spellingArea.appendChild(btn);
            });

            // Add empty slots
            for (let i = playerSpelling.length; i < currentWord.length; i++) {
                const slot = document.createElement('div');
                slot.className = 'letter-slot empty-slot';
                slot.textContent = '?';
                spellingArea.appendChild(slot);
            }

            // Update available letters
            const availableArea = document.getElementById('availableLetters');
            availableArea.innerHTML = '';
            
            availableLetters.forEach((letter, index) => {
                const btn = document.createElement('button');
                btn.className = 'available-letter';
                btn.textContent = letter;
                
                // Assign random color
                const colorIndex = index % letterColors.length;
                btn.style.backgroundColor = letterColors[colorIndex];
                btn.style.color = '#FFF';
                
                btn.onclick = () => addLetterToSpelling(letter, index);
                availableArea.appendChild(btn);
            });

            // Update check button
            const checkBtn = document.getElementById('checkBtn');
            checkBtn.disabled = playerSpelling.length !== currentWord.length;

            // Update score
            document.getElementById('scoreValue').textContent = score;
        }

        function addLetterToSpelling(letter, index) {
            playerSpelling.push(letter);
            availableLetters.splice(index, 1);
            updateUI();
        }

        function removeLetterFromSpelling(index) {
            const letter = playerSpelling[index];
            availableLetters.push(letter);
            playerSpelling.splice(index, 1);
            updateUI();
        }

        function checkSpelling() {
            const spelled = playerSpelling.join('');
            if (spelled === currentWord) {
                score += 10;
                showSuccess();
                setTimeout(() => {
                    hideSuccess();
                    showDrawingSection();
                }, 2000);
            } else {
                // Wrong - reset
                playerSpelling = [];
                generateScatteredLetters();
                updateUI();
            }
        }

        function showSuccess() {
            document.getElementById('successWord').textContent = currentWord;
            document.getElementById('successModal').style.display = 'flex';
        }

        function hideSuccess() {
            document.getElementById('successModal').style.display = 'none';
        }

        function showDrawingSection() {
            document.getElementById('spellingSection').classList.add('hide');
            document.getElementById('drawingSection').classList.add('show');
            hasDrawn = false;
            hideNextWordButton();
            
            // Update reference image
            const wordObj = words.find(w => w.word === currentWord);
            document.getElementById('drawingReference').src = wordObj.image;
            document.getElementById('drawingReference').alt = `Reference: ${currentWord.toLowerCase()}`;
            
            // Load reference image for canvas but don't show it yet
            loadReferenceImage();
            
            // Reset trace state - hide reference by default
            traceVisible = false;
            document.getElementById('traceToggle').textContent = 'Show Reference Image';
            document.getElementById('traceToggle').classList.remove('active');
            document.getElementById('traceCanvas').style.display = 'none';
            
            // Clear canvas to ensure clean start
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        function showSpellingSection() {
            document.getElementById('spellingSection').classList.remove('hide');
            document.getElementById('drawingSection').classList.remove('show');
        }

        function showNextWordButton() {
            document.getElementById('nextWordBtn').classList.add('show');
        }

        function hideNextWordButton() {
            document.getElementById('nextWordBtn').classList.remove('show');
        }

        function nextWord() {
            // Move to next word in sequence to avoid repeats
            currentWordIndex = (currentWordIndex + 1) % words.length;
            currentWord = words[currentWordIndex].word;
            playerSpelling = [];
            generateScatteredLetters();
            showSpellingSection(); // Show spelling section for new word
            updateUI();
            clearCanvas();
            
            // Reset reference image for new word
            referenceImage = null;
        }

        // Initialize the game when page loads
        window.onload = init;
    </script>
</body>
</html>